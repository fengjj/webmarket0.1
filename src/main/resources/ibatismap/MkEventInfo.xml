<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap 
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">


<sqlMap namespace="MkEventInfo">

	<sql id="select-all-column">
	SELECT
		event_id AS eventId,
		event_name AS eventName,
		action_id AS actionId,
		conduct_id AS conductId,
		status_code AS statusCode,
		region_code AS regionCode,
		start_date AS startDate,
		end_date AS endDate,
		oper_no AS operNo,
		oper_name AS operName,
		oper_time AS operDate,
		event_type AS busiType,
		event_desc AS eventDesc,
		priority_code AS priorityCode,
		max_order_num AS eventMaxCount
	FROM mk_event_info
	</sql>
	
	<sql id="where-all-condition">
	<dynamic prepend=" WHERE ">
			<isNotNull property="eventId" prepend="and">
				<isNotEmpty property="eventId"> 
					event_id = #eventId#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="eventName" prepend="and">
				<isNotEmpty property="eventName">
					event_name = #eventName#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="actionId" prepend="and">
				<isNotEmpty property="actionId">
					action_id = #actionId#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="conductId" prepend="and">
				<isNotEmpty property="conductId">
					conduct_id = #conductId#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="statusCode" prepend="and">
				<isNotEmpty property="statusCode">
					status_code = #statusCode#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="regionCode" prepend="and">
				<isNotEmpty property="regionCode">
					region_code = #regionCode#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="startDateStart" prepend="and">
				<isNotEmpty property="startDateStart">
					<![CDATA[ start_date >= #startDateStart# ]]>
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="startDateEnd" prepend="and">
				<isNotEmpty property="startDateEnd">
					<![CDATA[ start_date <= #startDateEnd# ]]>
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="endDateStart" prepend="and">
				<isNotEmpty property="endDateStart">
					<![CDATA[ end_date >= #endDateStart# ]]>
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="endDateEnd" prepend="and">
				<isNotEmpty property="endDateEnd">
					<![CDATA[ end_date <= #endDateEnd# ]]>
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="operNo" prepend="and">
				<isNotEmpty property="operNo">
					oper_no = #operNo#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="operName" prepend="and">
				<isNotEmpty property="operName">
					oper_name = #operName#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="operDateStart" prepend="and">
				<isNotEmpty property="operDateStart">
					<![CDATA[ date_format(oper_time,'%Y%m%d') >= date_format(#operDateStart#,'%Y%m%d') ]]>
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="operDateEnd" prepend="and">
				<isNotEmpty property="operDateEnd">
					<![CDATA[  date_format(oper_time,'%Y%m%d') <= date_format(#operDateEnd#,'%Y%m%d') ]]>
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="busiType" prepend="and">
				<isNotEmpty property="busiType">
					event_type = #busiType#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="eventDesc" prepend="and">
				<isNotEmpty property="eventDesc">
					event_desc = #eventDesc#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="priorityCode" prepend="and">
				<isNotEmpty property="priorityCode">
					priority_code = #priorityCode#
				</isNotEmpty>
			</isNotNull>
	</dynamic>
	</sql>
	<select id="selectMkEventInfoById" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		<include refid="select-all-column"/>
		WHERE event_id = #eventId#
	</select>

	<select id="selectMkEventInfo" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		<include refid="select-all-column"/>
		<include refid="where-all-condition"/>
	</select>
	
	<insert id="insertMkEventInfo" parameterClass="java.util.Map">
	INSERT INTO mk_event_info (
		event_id,
		event_name,
		action_id,
		conduct_id,
		status_code,
		region_code,
		start_date,
		end_date,
		oper_no,
		oper_name,
		oper_time,
		event_type,
		event_desc,
		priority_code,
		max_order_num
	) VALUES (
		#eventId# ,
		#eventName# ,
		#actionId# ,
		#conductId# ,
		#statusCode# ,
		#regionCode# ,
		DATE_FORMAT( #startDate#, '%Y-%m-%d'),
		DATE_FORMAT( #endDate#, '%Y-%m-%d'),
		#operNo# ,
		#operName# ,
		#operDate# ,
		#eventType# ,
		#eventDesc# ,
		#priorityCode#,
		#eventMaxCount#     
	)
	</insert>
	
	
	
	<update id="updateMkEventInfoById" parameterClass="java.util.Map">
	UPDATE mk_event_info
	<dynamic prepend=" SET ">
		<isNotNull property="eventName" prepend=",">
			event_name = #eventName#
		</isNotNull>
		<isNotNull property="actionId" prepend=",">
			action_id = #actionId#
		</isNotNull>
		<isNotNull property="conductId" prepend=",">
			conduct_id = #conductId#
		</isNotNull>
		<isNotNull property="statusCode" prepend=",">
			status_code = #statusCode#
		</isNotNull>
		<isNotNull property="regionCode" prepend=",">
			region_code = #regionCode#
		</isNotNull>
		<isNotNull property="startDate" prepend=",">
			start_date = #startDate#
		</isNotNull>
		<isNotNull property="endDate" prepend=",">
			end_date = #endDate#
		</isNotNull>
		<isNotNull property="operNo" prepend=",">
			oper_no = #operNo#
		</isNotNull>
		<isNotNull property="operName" prepend=",">
			oper_name = #operName#
		</isNotNull>
		<isNotNull property="operDate" prepend=",">
			oper_time = #operDate#
		</isNotNull>
		<isNotNull property="busiType" prepend=",">
			event_type = #busiType#
		</isNotNull>
		<isNotNull property="eventDesc" prepend=",">
			event_desc = #eventDesc#
		</isNotNull>
		<isNotNull property="priorityCode" prepend=",">
			priority_code = #priorityCode#
		</isNotNull>
	</dynamic>
	WHERE event_id = #eventId#
	</update>
	
	<delete id="deleteMkEventInfoById" parameterClass="java.util.Map">
	DELETE FROM mk_event_info
	WHERE event_id = #eventId#
	</delete>

	
	<select id="selectMkEventInfoParam" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		<include refid="select-all-column"/> 
		where 1=1
		<isNotNull property="eventId">
			<isNotEmpty property="eventId">
			<![CDATA[
				and event_id like concat('%', #eventId#, '%')
			]]>	
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="statusCode">
			<isNotEmpty property="statusCode">
			<![CDATA[
				and status_code = #statusCode#
			]]>	
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="eventName">
			<isNotEmpty property="eventName">
			<![CDATA[
				and event_name like concat('%', #eventName#, '%')
			]]>	
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="startDate">
			<isNotEmpty property="startDate">
			<![CDATA[
				and oper_time >= DATE_FORMAT( #startDate#, '%Y-%m-%d')
			]]>	
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="endDate">
			<isNotEmpty property="endDate">
			<![CDATA[
				and oper_time <= DATE_FORMAT( #endDate#, '%Y-%m-%d')
			]]>	
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="operNo" prepend="and">
				<isNotEmpty property="operNo">
					oper_no = #operNo#
				</isNotEmpty>
			</isNotNull>
		<![CDATA[  order by oper_time desc  ]]>
	</select>
	<update id="updateStatusMkEventInfo" parameterClass="java.util.Map">
		update mk_event_info 
		set status_code = '01' 
		where event_id =#serialNo#
	</update>
	
	<update id="updateMkEventInfoStatus" parameterClass="java.util.Map">
		update mk_event_info 
		set status_code = #statuscode# 
		where event_id =#eventId#
	</update>
	<select id="selectEventInfoByid" parameterClass="java.util.Map" resultClass="java.util.HashMap">
	select e.event_id,e.event_name AS eventName,
	e.event_type AS busiType,
	e.oper_no AS operNo,
	e.oper_time AS operDate,
    min(case actconduct_par_id when '10021' then actconduct_par_value ELSE 'ALL' end) as custGroupId 
from mk_eventcontent_info i,mk_event_info e where 
    i.event_id = e.event_id
    and e.event_id=#serialNo#
	group by  event_id,batch_no

	</select>
	<insert id="insertMkEventTracByEventid" parameterClass="java.util.Map">
	INSERT INTO mk_event_trac(
	TRAC_ID ,
	UPDATE_TYPE ,
	EVENT_ID,
	EVENT_NAME,
	ACTION_ID ,
	CONDUCT_ID,
	STATUS_CODE ,
	REGION_CODE ,
	START_DATE,
	END_DATE,
	OPER_NO ,
	OPER_NAME ,
	OPER_TIME ,
	UPDATE_NO,
    UPDATE_NAME,
    UPDATE_TIME,
	EVENT_TYPE ,
	EVENT_DESC,
	PRIORITY_CODE ,
	MAX_ORDER_NUM
	 )
	 select #trac_id#,
         #update_type#,
         EVENT_ID,
         EVENT_NAME,
         ACTION_ID,
         CONDUCT_ID,
         STATUS_CODE,
         REGION_CODE,
         START_DATE,
         END_DATE,
         OPER_NO,
         OPER_NAME,
         OPER_TIME,
         #login_no#,
         #login_name#,
         now(),
         EVENT_TYPE,
         EVENT_DESC,
         PRIORITY_CODE,
         MAX_ORDER_NUM
    from mk_event_info
	where 
	event_id = #eventId#
	</insert>
	<select id="selectActconduct" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select distinct 
		t.action_id AS actionId,
		t.conduct_id AS conductId,
		t.event_name AS eventName,
		t.status_code AS batchNo
		from mk_event_info  t 
		where t.event_id=#eventId# 
	</select>
</sqlMap>
