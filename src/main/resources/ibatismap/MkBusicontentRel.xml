<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap 
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">


<sqlMap namespace="MkBusicontentRel">


	<sql id="select-all-column">
	SELECT
		rel_id AS relId,
		busi_id AS busiId,
		busi_type AS busiType,
		content_serial_id AS contentSerialId,
		phone_type AS phoneType,	
		impower_flag AS impowerFlag,
		costuse_flag AS costuseFlag
	FROM mk_busicontent_rel
	</sql>
	
	<sql id="where-all-condition">
	<dynamic prepend=" WHERE ">
			<isNotNull property="relId" prepend="and">
				<isNotEmpty property="relId">
					rel_id = #relId#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="busiId" prepend="and">
				<isNotEmpty property="busiId">
					busi_id = #busiId#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="busiIdList" prepend="and">
				<isNotEmpty property="busiIdList">
				    busi_id in 
					<iterate property="busiIdList" open="(" close=")" conjunction=","> 
						#busiIdList[]#
					</iterate>
				</isNotEmpty>
		    </isNotNull>
			<isNotNull property="busiType" prepend="and">
				<isNotEmpty property="busiType">
					busi_type = #busiType#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="contentSerialId" prepend="and">
				<isNotEmpty property="contentSerialId">
					content_serial_id = #contentSerialId#
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="contentSerialIdList" prepend="and">
				<isNotEmpty property="contentSerialIdList">
				    content_serial_id in 
					<iterate property="contentSerialIdList" open="(" close=")" conjunction=","> 
						#contentSerialIdList[]#
					</iterate>
				</isNotEmpty>
		    </isNotNull>
			<isNotNull property="impowerFlag" prepend="and">
				<isNotEmpty property="impowerFlag">
					impower_flag = #impowerFlag#
				</isNotEmpty>
			</isNotNull>
	</dynamic>
	</sql>
	<select id="selectMkBusicontentRelById" parameterClass="java.lang.String" resultClass="java.util.HashMap">
		<include refid="select-all-column"/>
		WHERE rel_id = #relId#
	</select>

	<select id="selectMkBusicontentRel" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		<include refid="select-all-column"/>
		<include refid="where-all-condition"/>
	</select>
	
	<select id="selectMkBusicontentRelByName" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 
		a.rel_id As relId,
		a.busi_id AS busiId,
		b.content_type AS contentType,
		b.content_name AS contentName 
		FROM mk_busicontent_rel a,mk_content_info b 
		WHERE a.content_serial_id = b.content_serial_id
		<isNotNull property="busiId" prepend="and">
			<isNotEmpty property="busiId">
				busi_id = #busiId#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="busiType" prepend="and">
			<isNotEmpty property="busiType">
				busi_type = #busiType#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="busiIdList" prepend="and">
			<isNotEmpty property="busiIdList">
				busi_id in 
				<iterate property="busiIdList" open="(" close=")" conjunction=","> 
					#busiIdList[]#
				</iterate>
			</isNotEmpty>
		</isNotNull>
	</select>
	
	<insert id="insertMkBusicontentRel" parameterClass="java.util.Map">
	<![CDATA[
	INSERT INTO mk_busicontent_rel
	]]>
	<dynamic prepend=" (  ">
		<isNotNull property="relId" prepend=",">
			<isNotEmpty property="relId">
				rel_id
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="busiId" prepend=",">
			<isNotEmpty property="busiId">
				busi_id
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="busiType" prepend=",">
			<isNotEmpty property="busiType">
				busi_type
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="contentSerialId" prepend=",">
			<isNotEmpty property="contentSerialId">
				content_serial_id
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="phoneType" prepend=",">
			<isNotEmpty property="phoneType">
				phone_type
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="impowerFlag" prepend=",">
			<isNotEmpty property="impowerFlag">
				impower_flag
			</isNotEmpty>
		</isNotNull>
		</dynamic>
	    <dynamic prepend=" ) VALUES (  ">
		<isNotNull property="relId" prepend=",">
			<isNotEmpty property="relId">
				#relId#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="busiId" prepend=",">
			<isNotEmpty property="busiId">
				#busiId#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="busiType" prepend=",">
			<isNotEmpty property="busiType">
				#busiType#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="contentSerialId" prepend=",">
			<isNotEmpty property="contentSerialId">
				#contentSerialId#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="phoneType" prepend=",">
			<isNotEmpty property="phoneType">
				#phoneType#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="impowerFlag" prepend=",">
			<isNotEmpty property="impowerFlag">
				#impowerFlag#
			</isNotEmpty>
		</isNotNull>
	</dynamic>
	
	)
	</insert>
	
	<update id="updateMkBusicontentRel" parameterClass="java.util.Map">
	UPDATE mk_busicontent_rel
	<dynamic prepend=" SET ">
		<isNotNull property="relId" prepend=",">
		    <isNotEmpty property="relId">
			    rel_id = #relId#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="busiId" prepend=",">
		    <isNotEmpty property="busiId">
			    busi_id = #busiId#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="busiType" prepend=",">
		    <isNotEmpty property="busiType">
			    busi_type = #busiType#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="contentSerialId" prepend=",">
		    <isNotEmpty property="contentSerialId">
			    content_serial_id = #contentSerialId#
			</isNotEmpty>
		</isNotNull>
	</dynamic>

	<include refid="where-all-condition"/>
	</update>
	
	<delete id="deleteMkBusicontentRelById" parameterClass="java.util.Map">
	DELETE FROM mk_busicontent_rel
	WHERE rel_id = #relId#
	</delete>
	
	<select id="selectMkBusicontentRelParam" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		<isEmpty property="S">
			SELECT
			rel_id AS relId,
			busi_id AS busiId,
			busi_type AS busiType,
			content_serial_id AS contentSerialId
		</isEmpty>
		<isNotEmpty property="S">
			SELECT $S$
		</isNotEmpty>
		 	FROM mk_busicontent_rel $W$
	</select>
	
	<delete id="deleteMkBusiContentRelByBusiId" parameterClass="java.util.Map">
	DELETE FROM mk_busicontent_rel
	WHERE busi_id = #busiId# and busi_type= #busiType#
	</delete>
	<!--复制营销档次和内容关系 -->
	<insert id="copyMkBusiContentRel" parameterClass="java.util.HashMap"
		>
		insert into mk_busicontent_rel(
		rel_id,
		busi_id,
		busi_type,
		content_serial_id,
		phone_type
		)
		select #relId#,
		#newbusiId#,
		busi_type,
		#newcontentSerialId#,
		phone_type
		from mk_busicontent_rel 
		where content_serial_id = #contentSerialId# 
		and busi_id=#busiId#
		and busi_type = #busiType#
	</insert>
	<select id="selectBusicontentInfo" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select b.content_serial_id as contentSerialId,
			b.content_name as contentName
			from mk_busicontent_rel a,mk_content_info b,mk_codename_dict c
		where a.content_serial_id = b.content_serial_id
		and c.table_en_name = 'mk_contenttype_dict'
		and c.field_value = b.content_type
		and a.busi_id = #busiId#
		and a.busi_type = #busiType#
		order by b.content_serial_id
	</select>
	<delete id="delBusicontentRel" parameterClass="java.util.Map">
		DELETE FROM mk_busicontent_rel
		<include refid="where-all-condition"/>
	</delete>
	
	<!-- 根据内容流水获取规则信息 -->
	<select id="selectRuleInfoByConSerialId" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select
			a.busi_id as busiId,
			a.rule_serial_id as ruleSerialId ,
			b.content_serial_id as contentSerialId ,
			b.phone_type as phoneType 
		from
			mk_busirule_rel a,
			mk_busicontent_rel b
		where a.busi_id = b.busi_id
		<isNotNull property="contentSerialId" prepend="and">
			<isNotEmpty property="contentSerialId">
				b.content_serial_id = #contentSerialId#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="ruleBusiType" prepend="and">
			<isNotEmpty property="ruleBusiType">
				a.busi_type = #ruleBusiType#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="conBusiType" prepend="and">
			<isNotEmpty property="conBusiType">
				b.busi_type = #conBusiType#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="contentSerialIdList" prepend="and">
			<isNotEmpty property="contentSerialIdList">
				b.content_serial_id in 
				<iterate property="contentSerialIdList" open="(" close=")" conjunction=","> 
					#contentSerialIdList[]#
				</iterate>
			</isNotEmpty>
		</isNotNull>
	</select>
	
	<!-- 根据内容流水获取活动ID -->
	<select id="selectActIdByConSerialId" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select
			a.busi_id as busiId,
			a.means_id as meansId,
			b.content_serial_id as contentSerialId,
			b.phone_type as phoneType,
			b.rel_id as relId
		from
			mk_busimeans_rel a,
			mk_busicontent_rel b
		where a.means_id = b.busi_id
		<isNotNull property="busiId" prepend="and">
			<isNotEmpty property="busiId">
				a.busi_id = #busiId#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="meansBusiType" prepend="and">
			<isNotEmpty property="meansBusiType">
				a.busi_type = #meansBusiType#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="conBusiType" prepend="and">
			<isNotEmpty property="conBusiType">
				b.busi_type = #conBusiType#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="contentSerialIdList" prepend="and">
			<isNotEmpty property="contentSerialIdList">
				b.content_serial_id in 
				<iterate property="contentSerialIdList" open="(" close=")" conjunction=","> 
					#contentSerialIdList[]#
				</iterate>
			</isNotEmpty>
		</isNotNull>
	</select>
</sqlMap>
